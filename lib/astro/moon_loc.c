/*
 *	moon_loc.c 
 *
 *	Coded by K.Osada
 *
 *      Nov. 25, 1990
 *      Dec. 05, 1990
 *
 *	$Header: MOON_LOC.Cv  1.7  90/12/14 09:52:24  yamane  Rel $
 */

#include	<math.h>
#include	<stdio.h>

#include	"astrolib.h"
#include	"eph.h"

static struct {
	float	a;
	float	b;
	double	c;
} data_lamda[] = {
/*		a				b			  c		 */
	{	1.2740,		107.248,	 -4133.3536 },
	{	0.6583,		 51.668,	  8905.3422 },
	{	0.2136,		317.831,	  9543.9773 },
	{	0.1856,		176.531,	   359.9905 },
	{	0.1143,		292.463,	  9664.0404 },
	{	0.0588,		 86.16 ,	   638.635  },
	{	0.0572,		103.78 ,	 -3773.363  },
	{	0.0533,		 30.58 ,	 13677.331  },
	{	0.0459,		124.86 ,	 -8545.352  },
	{	0.0410,		342.38 ,	  4411.998  },
	{	0.0348,		 25.83 ,	  4452.671  },
	{	0.0305,		155.45 ,	  5131.979  },
	{	0.0153,		240.79 ,	   758.698  },
	{	0.0125,		271.38 ,	 14436.029  },
	{	0.0110,		226.45 ,	 -4892.052  },
	{	0.0107,		 55.58 ,	-13038.696  },
	{	0.0100,		296.75 ,	 14315.966  },
	{	0.0085,		 34.5  ,	 -8266.71   },
	{	0.0079,		290.7  ,	 -4493.34   },
	{	0.0068,		228.2  ,	  9265.33   },
	{	0.0052,		133.1  ,	   319.32   },
	{	0.0050,		202.4  ,	  4812.66   },
	{	0.0048,		 68.6  ,	   -19.34   },
	{	0.0040,		 34.1  ,	 13317.34   },
	{	0.0040,		  9.5  ,	 18449.32   },
	{	0.0040,		 93.8  ,	    -1.33   },
	{	0.0039,		103.3  ,	 17810.68   },
	{	0.0037,		 65.1  ,	  5410.62   },
	{	0.0027,		321.3  ,	  9183.99   },
	{	0.0026,		174.8  ,	-13797.39   },
	{	0.0024,		 82.7  ,	   998.63   },
	{	0.0024,		  4.7  ,	  9224.66   },
	{	0.0022,		121.4  ,	 -8185.36   },
	{	0.0021,		134.4  ,	  9903.97   },
	{	0.0021,		173.1  ,	   719.98   },
	{	0.0021,		100.3  ,	 -3413.37   },
	{	0.0020,		248.6  ,	   -19.34   },
	{	0.0018,		 98.1  ,	  4013.29   },
	{	0.0016,		344.1  ,	 18569.38   },
	{	0.0012,		 52.1  ,	-12678.71   },
	{	0.0011,		250.3  ,	 19208.02   },
	{	0.0009,		 81.0  ,	 -8586.0    },
	{	0.0008,		207.0  ,	 14037.3    },
	{	0.0008,		 31.0  ,	 -7906.7    },
	{	0.0007,		346.0  ,	  4052.0    },
	{	0.0007,		294.0  ,	 -4853.3    },
	{	0.0007,		 90.0  ,	   278.6    },
	{	0.0006,		237.0  ,	  1118.7    },
	{	0.0005,		 82.0  ,	 22582.7    },
	{	0.0005,		276.0  ,	 19088.0    },
	{	0.0005,		 73.0  ,	-17450.7    },
	{	0.0005,		112.0  ,	  5091.3    },
	{	0.0004,		116.0  ,	  -398.7    },
	{	0.0004,		 25.0  ,	  -120.1    },
	{	0.0004,		181.0  ,	  9584.7    },
	{	0.0004,		 18.0  ,	   720.0    },
	{	0.0003,		 60.0  ,	 -3814.0    },
	{	0.0003,		 13.0  ,	 -3494.7    },
	{	0.0003,		 13.0  ,	 18089.3    },
	{	0.0003,		152.0  ,	  5492.0    },
	{	0.0003,		317.0  ,	   -40.7    },
	{	0.0003,		348.0  ,	 23221.3    },
};

static struct {
	float	a;
	float	b;
	double	c;
} data_beta[] = {
/*		a				b			  c		 */
	{	0.2806,		215.147,	  9604.0088 },
	{	0.2777,		 77.316,	    60.0316 },
	{	0.1732,		  4.563,	 -4073.3220 },
	{	0.0554,		308.98 ,	  8965.374  },
	{	0.0463,		343.48 ,	   698.667  },
	{	0.0326,		287.90 ,	 13737.362  },
	{	0.0172,		194.06 ,	 14375.997  },
	{	0.0093,		 25.6  ,	 -8845.31   },
	{	0.0088,		 98.4  ,	 -4711.96   },
	{	0.0082,		  1.1  ,	 -3713.33   },
	{	0.0043,		322.4  ,	  5470.66   },
	{	0.0042,		266.8  ,	 18509.35   },
	{	0.0034,		188.0  ,	 -4433.31   },
	{	0.0025,		312.5  ,	  8605.38   },
	{	0.0022,		291.4  ,	 13377.37   },
	{	0.0021,		340.0  ,	  1058.66   },
	{	0.0019,		218.6  ,	  9244.02   },
	{	0.0018,		291.8  ,	 -8206.68   },
	{	0.0018,		 52.8  ,	  5192.01   },
	{	0.0017,		168.7  ,	 14496.06   },
	{	0.0016,		 73.8  ,	   420.02   },
	{	0.0015,		262.1  ,	  9284.69   },
	{	0.0015,		 31.7  ,	  9964.00   },
	{	0.0014,		260.8  ,	  -299.96   },
	{	0.0013,		239.7  ,	  4472.03   },
	{	0.0013,		 30.4  ,	   379.35   },
	{	0.0012,		304.9  ,	  4812.68   },
	{	0.0012,		 12.4  ,	 -4851.36   },
	{	0.0011,		173.0  ,	 19147.99   },
	{	0.0010,		312.9  ,	-12978.66   },
	{	0.0008,		  1.0  ,	 17870.7    },
	{	0.0008,		190.0  ,	  9724.1    },
	{	0.0007,		 22.0  ,	 13098.7    },
	{	0.0006,		117.0  ,	  5590.7    },
	{	0.0006,		 47.0  ,	-13617.3    },
	{	0.0005,		 22.0  ,	 -8485.3    },
	{	0.0005,		150.0  ,	  4193.4    },
	{	0.0004,		119.0  ,	 -9483.9    },
	{	0.0004,		246.0  ,	 23281.3    },
	{	0.0004,		301.0  ,	 10242.6    },
	{	0.0004,		126.0  ,	  9325.4    },
	{	0.0004,		104.0  ,	 14097.4    },
	{	0.0003,		340.0  ,	 22642.7    },
	{	0.0003,		270.0  ,	 18149.4    },
	{	0.0003,		358.0  ,	 -3353.3    },
	{	0.0003,		148.0  ,	 19268.0    },
};


static struct {
	float	a;
	float	b;
	double	c;
} data_pai[] = {
/*		a				b			  c		 */
	{	0.0518,		338.92 ,	  4771.989  },
	{	0.0095,		287.2  ,	 -4133.35   },
	{	0.0078,		 51.7  ,	  8905.34   },
	{	0.0028,		317.8  ,	  9543.98   },
	{	0.0009,		 31.0  ,	 13677.3    },
	{	0.0005,		305.0  ,	 -8545.4    },
	{	0.0004,		284.0  ,	 -3773.4    },
	{	0.0003,		342.0  ,	  4412.0    },
};

static struct {
	float	a;
	float	b;
	float	c;
} data_a[] = {
/*		a				b		  	c		 */
	{	0.0040,		 93.8  ,	    -1.33   },
	{	0.0020,		248.6  ,	   -19.34   },
	{	0.0006,		 66.0  ,	     0.2    },
	{	0.0006,		249.0  ,	   -19.3    },
};

static struct {
	float	a;
	float	b;
	float	c;
} data_b[] = {
/*		a				b			  c		 */
	{	0.0267,	     68.64 ,       -19.341  },
	{	0.0043,	    342.0  ,	   -19.36   },
	{	0.0040,	     93.8  ,	    -1.33   },
	{	0.0020,     248.6  ,	   -19.34   },
	{	0.0005,	    358.0  ,	   -19.4    },
};


void
moon_loc(jd,	ecl_pos,	sin_pai)
double	jd;
double	*sin_pai;
Xyz	*ecl_pos;
{
	register int	i,	n;
	double			t,	a,	b;
	double			lamda,	beta;
	double			wk,	sin_lamda,	cos_lamda,	sin_beta,	cos_beta;

	t = (jd - 2442412.5) / 365.25;
	t += (0.0317*t + 1.43)*1.0e-6;

	a = 0.0;
	n = sizeof(data_a) / sizeof(data_a[0]);
	for ( i = 0; i < n; i++ ) {
		a += ( data_a[i].a * sin(DEG2RAD(data_a[i].b + data_a[i].c * t)) );
	}

	b = 0.0;
	n = sizeof(data_b) / sizeof(data_b[0]);
	for ( i = 0; i < n; i++ ) {
		b += ( data_b[i].a * sin(DEG2RAD(data_b[i].b + data_b[i].c * t)) );
	}

	lamda = 124.8754 + 4812.67881 * t
		  + 6.2887 * sin(DEG2RAD(338.915 + 4771.9886 * t + a));
	n = sizeof(data_lamda) / sizeof(data_lamda[0]);
	for ( i = 0; i < n; i++ ) {
		lamda += ( data_lamda[i].a
					* sin(DEG2RAD(data_lamda[i].b + data_lamda[i].c * t)) );
	}

	beta = 5.1282 * sin(DEG2RAD(236.231 + 4832.0202 * t + b));
	n = sizeof(data_beta) / sizeof(data_beta[0]);
	for ( i = 0; i < n; i++ ) {
		beta += ( data_beta[i].a
				* sin(DEG2RAD(data_beta[i].b + data_beta[i].c * t)) );
	}

	*sin_pai = DEG2RAD(0.9507);
	n = sizeof(data_pai) / sizeof(data_pai[0]);
	for ( i = 0; i < n; i++ ) {
		*sin_pai += ( DEG2RAD( data_pai[i].a
				* cos(DEG2RAD(data_pai[i].b + data_pai[i].c * t)) ) );
	}

	wk = DEG2RAD(lamda);
	sin_lamda = sin(wk);
	cos_lamda = cos(wk);
	wk = DEG2RAD(beta);
	sin_beta  = sin(wk);
	cos_beta  = cos(wk);

	ecl_pos->x = cos_beta * cos_lamda;
	ecl_pos->y = cos_beta * sin_lamda;
	ecl_pos->z = sin_beta;
}


void
moon( jd, equinox_jd, ra, decl, sin_pai)
double	jd,	equinox_jd;
double	*ra,	*decl,	*sin_pai;
{
	double	wk;
	Xyz		ecl_pos;
	Xyz		equ_pos;
	Xyz		pos;

	moon_loc( jd, &ecl_pos, &wk );
	ecl2equ( jd, ecl_pos, &equ_pos );
	prec_b( jd, equinox_jd, equ_pos, &pos );
	*ra = in_pix2( atan2( pos.y, pos.x ) );
	*decl = atan2( pos.z, hypot( pos.x, pos.y ) );
	*sin_pai = wk;
}

/* ****************  end of moon_loc.c  **************** */
